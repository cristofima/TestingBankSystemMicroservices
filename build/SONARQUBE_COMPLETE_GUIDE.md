# SonarQube Integration Complete Guide

## Overview

This guide provides comprehensive instructions for integrating SonarQube code analysis and code coverage into Azure DevOps CI pipelines for .NET microservices.

## Critical Issues and Solutions

### 1. SonarQube Scanner Mode (July 2025 Update)

**Issue**: SonarQube deprecated CLI/MSBuild scanner modes
**Solution**: Use `scannerMode: 'dotnet'` for all .NET projects

```yaml
- task: SonarQubePrepare@5
  inputs:
    scannerMode: "dotnet" # ✅ Required for .NET projects
    # scannerMode: 'MSBuild'  # ❌ Deprecated July 2025
```

### 2. Azure DevOps Test Argument Conflicts

**Issue**: `Duplicate '--results-directory' arguments` and `Duplicate '--logger' arguments`
**Root Cause**: Azure DevOps auto-injects `--logger trx --results-directory /temp/path` to DotNetCoreCLI@2 tasks

**Solution**: Remove conflicting arguments from manual specification:

```yaml
# ✅ Correct - Only specify necessary arguments
arguments: '--configuration $(buildConfiguration) --collect:"XPlat Code Coverage" --settings "$(Build.SourcesDirectory)/src/coverlet.runsettings"'

# ❌ Incorrect - Causes conflicts
arguments: '--configuration $(buildConfiguration) --logger "console;verbosity=normal" --results-directory $(resultsDirectory) --collect:"XPlat Code Coverage"'
```

### 3. Coverage File Path Resolution

**Issue**: SonarQube couldn't find coverage files generated by tests
**Solution**: Search multiple directory locations:

```yaml
# Pipeline configuration
sonar.cs.opencover.reportsPaths=$(Agent.TempDirectory)/**/*.xml,$(resultsDirectory)/**/*.xml

# sonar-project.properties fallback
sonar.cs.opencover.reportsPaths=$(Agent.TempDirectory)/**/*.xml,$(resultsDirectory)/**/*.xml,**/TestResults/**/coverage.opencover.xml
```

## Complete Working Configuration

### Azure DevOps Pipeline (ci-build-test.yml)

```yaml
variables:
  buildConfiguration: "Release"
  resultsDirectory: "$(Agent.TempDirectory)/TestResults"
  solution: "src/BankSystem.sln"

stages:
  - stage: BuildAndTest
    jobs:
      - job: BuildAndAnalyze
        pool:
          vmImage: "ubuntu-latest"

        steps:
          # SonarQube Preparation
          - task: SonarQubePrepare@5
            displayName: "Prepare SonarQube Analysis"
            inputs:
              SonarQube: "SonarQube"
              scannerMode: "dotnet"
              projectKey: "$(SONAR_PROJECT_KEY)"
              projectName: "$(SONAR_PROJECT_NAME)"
              extraProperties: |
                sonar.sources=src/services
                sonar.exclusions=**/bin/**/*,**/obj/**/*,**/Migrations/**/*,**/*.Designer.cs,**/ModelSnapshot.cs,**/Program.cs,**/tests/**/*
                sonar.tests=src/services/Security/tests,src/services/Account/tests,src/services/Movement/tests,src/services/Transaction/tests
                sonar.test.inclusions=**/*Test*.cs,**/*Tests.cs
                sonar.test.exclusions=**/bin/**/*,**/obj/**/*
                sonar.cs.opencover.reportsPaths=$(Agent.TempDirectory)/**/*.xml,$(resultsDirectory)/**/*.xml
                sonar.cs.vstest.reportsPaths=$(Agent.TempDirectory)/**/*.trx,$(resultsDirectory)/**/*.trx
                sonar.coverage.exclusions=**/tests/**/*,**/Migrations/**/*,**/*.Designer.cs,**/ModelSnapshot.cs,**/Program.cs
            condition: and(succeeded(), ne(variables['SONAR_PROJECT_KEY'], ''))

          # Build
          - task: DotNetCoreCLI@2
            displayName: "Build Solution"
            inputs:
              command: "build"
              projects: "$(solution)"
              arguments: "--configuration $(buildConfiguration)"

          # Test Execution
          - task: DotNetCoreCLI@2
            displayName: "Run Unit Tests with Code Coverage"
            inputs:
              command: "test"
              projects: "src/services/Security/tests/Security.Application.UnitTests/Security.Application.UnitTests.csproj"
              arguments: '--configuration $(buildConfiguration) --collect:"XPlat Code Coverage" --settings "$(Build.SourcesDirectory)/src/coverlet.runsettings"'
              publishTestResults: true

          - task: DotNetCoreCLI@2
            displayName: "Run Integration Tests with Code Coverage"
            inputs:
              command: "test"
              projects: "src/services/Security/tests/Security.Infrastructure.IntegrationTests/Security.Infrastructure.IntegrationTests.csproj"
              arguments: '--configuration $(buildConfiguration) --collect:"XPlat Code Coverage" --settings "$(Build.SourcesDirectory)/src/coverlet.runsettings"'
              publishTestResults: true
            continueOnError: true

          # Coverage File Management
          - bash: |
              echo "Listing coverage files in all possible locations..."
              find $(Agent.TempDirectory) -name "*.xml" -type f 2>/dev/null | grep -i coverage || echo "No coverage files in temp directory"
              find $(resultsDirectory) -name "*.xml" -type f 2>/dev/null | grep -i coverage || echo "No coverage files in custom directory"

              echo "Copying coverage files to ensure SonarQube can find them..."
              mkdir -p $(resultsDirectory)
              find $(Agent.TempDirectory) -name "*.xml" -path "*/coverage*" -exec cp {} $(resultsDirectory)/ \; 2>/dev/null || true

              echo "Final coverage files for SonarQube:"
              ls -la $(resultsDirectory)/*.xml 2>/dev/null || echo "No coverage files found"
            displayName: "Debug and Copy Coverage Files"

          # SonarQube Analysis
          - task: SonarQubeAnalyze@5
            displayName: "Run SonarQube Analysis"
            condition: and(succeeded(), ne(variables['SONAR_PROJECT_KEY'], ''))

          - task: SonarQubePublish@5
            displayName: "Publish SonarQube Results"
            inputs:
              pollingTimeoutSec: "300"
            condition: and(succeeded(), ne(variables['SONAR_PROJECT_KEY'], ''))
```

### SonarQube Configuration (sonar-project.properties)

```properties
# Project Configuration
sonar.projectKey=bank-system-microservices
sonar.projectName=Bank System Microservices
sonar.projectVersion=1.0

# Source code settings - exclude test directories
sonar.sources=src/services
sonar.exclusions=**/bin/**/*,**/obj/**/*,**/Migrations/**/*,**/*.Designer.cs,**/ModelSnapshot.cs,**/Program.cs,**/tests/**/*

# Test settings - only test directories
sonar.tests=src/services/Security/tests,src/services/Account/tests,src/services/Movement/tests,src/services/Transaction/tests
sonar.test.inclusions=**/*Test*.cs,**/*Tests.cs
sonar.test.exclusions=**/bin/**/*,**/obj/**/*

# Coverage settings - Multiple location support
sonar.cs.opencover.reportsPaths=$(Agent.TempDirectory)/**/*.xml,$(resultsDirectory)/**/*.xml,**/TestResults/**/coverage.opencover.xml
sonar.cs.vstest.reportsPaths=$(Agent.TempDirectory)/**/*.trx,$(resultsDirectory)/**/*.trx,**/TestResults/**/*.trx

# Coverage exclusions
sonar.coverage.exclusions=**/tests/**/*,**/Migrations/**/*,**/*.Designer.cs,**/ModelSnapshot.cs,**/Program.cs

# Language settings
sonar.sourceEncoding=UTF-8
```

### Coverlet Configuration (coverlet.runsettings)

```xml
<?xml version="1.0" encoding="utf-8"?>
<RunSettings>
  <DataCollectionRunSettings>
    <DataCollectors>
      <DataCollector friendlyName="XPlat code coverage">
        <Configuration>
          <Format>cobertura,opencover</Format>
          <Include>[Security.Api]*,[Security.Application]*,[Security.Domain]*,[Security.Infrastructure]*,[Account.*]*,[Movement.*]*,[Transaction.*]*</Include>
          <Exclude>[*.Tests]*,[*.UnitTests]*,[*.IntegrationTests]*,[*Test*]*,[*Mock*]*</Exclude>
          <ExcludeByAttribute>Obsolete,GeneratedCodeAttribute,CompilerGeneratedAttribute,ExcludeFromCodeCoverageAttribute</ExcludeByAttribute>
          <ExcludeByFile>**/Migrations/**/*.cs,**/bin/**/*.cs,**/obj/**/*.cs,**/*Designer.cs,**/*ModelSnapshot.cs,**/Program.cs</ExcludeByFile>
          <IncludeTestAssembly>false</IncludeTestAssembly>
          <SkipAutoProps>true</SkipAutoProps>
        </Configuration>
      </DataCollector>
    </DataCollectors>
  </DataCollectionRunSettings>
</RunSettings>
```

## Key Insights

### Azure DevOps Auto-Injection Behavior

The DotNetCoreCLI@2 task with `publishTestResults: true` automatically provides:

- `--logger trx` (test result logging)
- `--results-directory /temp/path` (results directory)
- Automatic test result publishing

**Manual specification should only include:**

- `--configuration $(buildConfiguration)`
- `--collect:"XPlat Code Coverage"`
- `--settings "path/to/coverlet.runsettings"`

### SonarQube Scanner Mode Requirements

- ❌ `scannerMode: 'MSBuild'` (deprecated July 2025)
- ❌ `scannerMode: 'CLI'` (deprecated July 2025)
- ✅ `scannerMode: 'dotnet'` (required for .NET projects)

### Coverage File Locations

Coverage files can be generated in different locations:

- `$(Agent.TempDirectory)` - Azure DevOps temp directory
- `$(resultsDirectory)` - Custom results directory
- `**/TestResults/**` - Default test results pattern

## Troubleshooting

### Pipeline Fails with "Duplicate Arguments"

1. Remove `--logger` and `--results-directory` from manual arguments
2. Verify `publishTestResults: true` is set on test tasks
3. Check that only necessary arguments are specified

### SonarQube Shows No Coverage

1. Verify coverage files exist after test execution
2. Check that `sonar.cs.opencover.reportsPaths` includes all possible locations
3. Ensure coverlet.runsettings specifies OpenCover format

### SonarQube Analysis Fails to Start

1. Verify `scannerMode: 'dotnet'` is set
2. Check SonarQube connection configuration
3. Ensure project key and name are correctly specified

### SonarQube Scanner Hangs During Plugin Loading

**Symptoms**:

- Scanner starts successfully
- Hangs at "Load/download plugins" step
- Pipeline times out or takes extremely long

**Common Causes and Solutions**:

1. **Network/Proxy Issues**

   ```yaml
   # Add timeout and retry settings to SonarQube task
   - task: SonarQubePrepare@7
     inputs:
       # ...existing config...
       extraProperties: |
         # ...existing properties...
         sonar.scanner.responseTimeout=300
         sonar.scanner.socketTimeout=300
     continueOnError: false
     timeoutInMinutes: 10 # Add pipeline timeout
   ```

2. **Large Project Size**

   ```yaml
   # Increase Java heap size for scanner
   - task: SonarQubePrepare@7
     inputs:
       # ...existing config...
       extraProperties: |
         # ...existing properties...
         sonar.scanner.javaOpts=-Xmx2g -XX:MaxMetaspaceSize=512m
   ```

3. **Too Many Files Being Analyzed**

   ```properties
   # Be more aggressive with exclusions in sonar-project.properties
   sonar.exclusions=**/bin/**/*,**/obj/**/*,**/node_modules/**/*,**/packages/**/*,**/Migrations/**/*,**/*.Designer.cs,**/ModelSnapshot.cs,**/Program.cs,**/tests/**/*,**/*.min.js,**/*.min.css
   ```

4. **SonarCloud Rate Limiting** (if using SonarCloud)

   ```yaml
   # Add delay between prepare and analyze steps
   - task: SonarQubePrepare@7
     # ...config...

   # Build and test steps...

   - bash: sleep 30
     displayName: "Wait for SonarCloud rate limiting"

   - task: SonarQubeAnalyze@5
     # ...config...
   ```

5. **Force Clean Scanner Cache**

   ```yaml
   # Add step before SonarQube prepare
   - bash: |
       rm -rf ~/.sonar/cache
       echo "SonarQube cache cleared"
     displayName: "Clear SonarQube Cache"
     condition: and(succeeded(), ne(variables['SONAR_PROJECT_KEY'], ''))
   ```

6. **Use Minimal Scanner Configuration** (Emergency Fallback)
   ```yaml
   - task: SonarQubePrepare@7
     inputs:
       SonarQube: "SonarQube"
       scannerMode: "dotnet"
       projectKey: "$(SONAR_PROJECT_KEY)"
       projectName: "$(SONAR_PROJECT_NAME)"
       # Remove all extraProperties temporarily to isolate the issue
     timeoutInMinutes: 5
   ```

## Verification Checklist

After applying these configurations:

- [ ] Pipeline runs without argument conflicts
- [ ] SonarQube analysis starts successfully
- [ ] Coverage files are found and copied
- [ ] Test results appear in Azure DevOps
- [ ] Code coverage metrics visible in SonarQube dashboard
- [ ] No migration files or test assemblies in coverage calculations

## Compatibility

This configuration works with:

- ✅ Azure DevOps hosted agents (ubuntu-latest, windows-latest)
- ✅ SonarQube July 2025+ versions
- ✅ .NET 9.0 projects
- ✅ Coverlet code coverage collection
- ✅ Both unit and integration tests

This guide consolidates all SonarQube integration knowledge and should be the single source of truth for SonarQube configuration in this project.
